<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="CPM.Registry.Cache">
<IncludeCode>CPM.LIB</IncludeCode>
<Super>%RegisteredObject</Super>
<TimeCreated>63576,52166.039005</TimeCreated>

<Property name="Config">
<Type>CPM.LIB.Config</Type>
<Private>1</Private>
</Property>

<Property name="Registry">
<Type>CPM.Registry.Client</Type>
<Private>1</Private>
</Property>

<Method name="%OnNew">
<FormalSpec>Config,Registry</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set ..Config=$select($data(Config):Config, 1:##class(CPM.LIB.Config).%New())
    set ..Registry=$select($data(Registry):Registry, 1:##class(CPM.Registry.Cache).%New(..Config, ##this))
    quit $$$OK
]]></Implementation>
</Method>

<Method name="Update">
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set Url=..Config.registry
    $$$UrlParser(Url,url)
    if .."_updated"'="" {
        set url("query")="stale=update_after&startkey="_.."_updated"
        set url("path")=$$$getParam(url, "path", "/-/all/since")
        write !,"Updating index",!
    } else {
        set url("path")=$$$getParam(url, "path", "/-/all/")
        write !,"Building the local index for the first time",!
    }
    
    set response=..Registry.Get(.url)
    #dim data As %ZEN.proxyObject
    set tSC=##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(response.Data,..%ClassName(1),.data,1)
    $$$ThrowOnError(tSC)
    
    quit $$$OK
]]></Implementation>
</Method>

<Method name="%DispatchGetProperty">
<Description>
Is used to get the value of an unknown property.</Description>
<FormalSpec>Property:%String</FormalSpec>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
    if $e(Property)="_" {
        quit:Property="_updated" ..Config.updated
    } else {
        set package=##class(CPM.Registry.Package).%OpenId(Property)
        set package.name=Property
        quit package
    }
    quit ""
]]></Implementation>
</Method>

<Method name="%DispatchSetProperty">
<Description>
is used to set the value of an unknown property.</Description>
<FormalSpec>Property:%String,Val</FormalSpec>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
    if $e(Property)="_" {
        if Property="_updated" {
            set ..Config.updated=Val
        }
    } else {
        do ##class(CPM.Registry.Package).Load(Property, Val)
    }
    quit $$$OK
]]></Implementation>
</Method>
</Class>
</Export>
